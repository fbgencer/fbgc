// This file is part of fbgc

// fbgc is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.

// fbgc is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.

// You should have received a copy of the GNU General Public License
// along with fbgc.  If not, see <https://www.gnu.org/licenses/>.
#include "fbgc.h"


//MATRIX_BEGIN
//Autogenerated by helper/grammar_gen2.py
int8_t left_matrix[93][16] = {
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{2,0,0,2,2,2,0,2,0,2,2,0,2,2,0,0},
{2,0,0,2,2,2,0,2,0,2,2,0,2,2,0,0},
{2,0,0,2,2,2,0,2,0,2,2,0,2,2,0,0},
{2,0,0,2,2,2,0,2,0,2,2,0,2,2,0,0},
{2,0,0,2,2,2,0,2,0,2,2,0,2,2,0,0},
{2,0,0,2,2,2,0,2,0,2,2,0,2,2,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{3,0,0,3,3,3,0,3,0,3,3,0,3,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{3,0,0,3,3,3,0,3,0,3,3,0,3,3,0,3},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{14,0,0,0,0,14,0,14,0,14,0,0,0,0,0,0},
{14,0,0,0,0,14,0,14,0,14,0,0,0,0,0,0},
{14,0,0,0,0,0,14,0,0,0,0,0,0,0,0,0},
{14,0,0,0,0,0,14,0,0,0,0,0,0,0,0,0},
{14,0,0,0,0,0,14,0,0,0,0,0,0,0,0,0},
{14,0,0,0,0,0,14,0,0,0,0,0,0,0,0,0},
{1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{14,0,0,0,0,0,14,0,0,0,0,0,0,0,0,0},
{1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{1,7,7,0,0,0,7,0,7,0,0,0,0,1,7,0},
{10,0,10,10,10,10,0,10,0,10,10,10,10,10,10,0},
{0,7,7,0,0,0,7,0,7,2,0,0,0,0,7,0},
{11,0,11,11,11,11,11,11,0,11,11,11,11,0,0,0},
{0,15,15,0,0,0,15,0,15,0,2,0,0,0,0,0},
{10,0,10,10,10,10,0,10,0,10,10,10,10,10,10,10},
{0,7,7,0,0,0,7,0,7,2,0,0,0,0,7,0},
{0,8,8,0,0,0,8,0,0,0,0,0,0,0,8,0},
{-16,0,16,-16,0,-16,16,-16,0,-16,-16,0,0,-16,0,0},
{1,1,1,0,0,0,1,0,1,0,0,0,0,0,1,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{-5,4,4,-5,-5,-5,4,-5,0,-5,-5,-5,0,0,4,0},
{-5,4,4,-5,-5,-5,4,-5,0,-5,-5,-5,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{-13,4,4,-13,-13,-13,4,-13,0,-13,-13,0,7,-13,4,0},
{0,4,4,0,0,0,4,0,0,0,0,0,0,0,4,0},
{5,0,0,5,5,5,0,5,0,5,5,5,0,0,0,0},
{5,0,0,5,5,5,0,5,0,5,5,5,0,0,0,0},
{5,0,0,5,5,5,0,5,0,5,5,5,0,0,0,0},
{5,0,0,5,5,5,0,5,0,5,5,5,0,0,0,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{0,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0},
{1,0,0,1,1,0,0,1,0,1,1,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{16,0,0,16,0,16,0,16,0,16,16,0,0,16,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
};
int8_t right_matrix[93][16] = {
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{1,2,3,4,5,6,7,8,9,10,11,12,13,14,3,16},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,7,0,0,0,0,7,0,0,0,0,0,0,0,0,0},
{0,7,0,0,0,0,7,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,9,9,0,0,0,9,0,0,0,0,0,0,0,9,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,0,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,7,7,0,0,0,7,0,7,0,0,0,0,0,7,0},
{0,13,13,0,0,0,13,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
};
//MATRIX_END


void gm_convert_left(struct parser_packet * p){
	#define gm_left  (p->gm)
	#define obj 	(p->iter)
	//Just check for special functions.
	int8_t new_left = left_matrix[obj->type][gm_left - 1];
	
	if(new_left < 0){

		new_left = -new_left;	

		FBGC_LOGV(GRAMMAR,"Grammar gm_left(%s) has a special function definition\n",gm2str(new_left));
		
		switch(obj->type){
			case PLUS:
			{
				obj->type = UPLUS;
				break;
			}
			case MINUS:
			{
				obj->type = UMINUS;
				break;
			}
			case PIPE:
			{
				obj->type = LEN;
				break;
			}
			case DOT:
			{
				obj->type = CLASS_SELF;
				break;
			}
			default:
			{
				assert(0);
				break;
			}	
		}

		//gm_left = new_left;
	}
	


	#undef gm_left
	#undef obj
}


uint8_t gm_seek_left(struct parser_packet * p){

	#define gm_left  (p->gm)
	#define obj 	(p->iter)
	//struct fbgc_ll_base * obj = p->iter;
	


	FBGC_LOGD(GRAMMAR,"Grammar LEFT:[%s],Obj:[%s]\n",gm2str(gm_left),lltp2str(obj));

	int8_t new_left = left_matrix[obj->type][gm_left-1];

	if(new_left == GM_ERROR){
		_FBGC_LOGE("Unexpected grammar! LEFT:(%s), OBJ:(%s)\n",gm2str(gm_left),lltp2str(obj));
	}

	gm_left = new_left;

	p->error_code = (new_left == GM_ERROR) ? _FBGC_SYNTAX_ERROR : _FBGC_NO_ERROR;

	return (new_left == GM_ERROR) ? _FBGC_SYNTAX_ERROR : _FBGC_NO_ERROR;

	#undef gm_left
	#undef obj
}

uint8_t gm_seek_right(struct parser_packet * p){

	#define gm_right  (p->gm)
	#define obj 	(TOP_LL(p->op))
	
	FBGC_LOGD(GRAMMAR,"Grammar Obj:[%s],RIGHT:[%s]\n",lltp2str(obj),gm2str(gm_right));

	int8_t new_right = right_matrix[obj->type][gm_right-1];

	if(new_right == GM_ERROR){
		_FBGC_LOGE("Unexpected grammar! Obj:(%s) RIGHT:(%s)\n",lltp2str(obj),gm2str(gm_right));
	}
	
	gm_right = new_right;
	p->error_code = (new_right == GM_ERROR) ? _FBGC_SYNTAX_ERROR : _FBGC_NO_ERROR;
	return (new_right == GM_ERROR) ? _FBGC_SYNTAX_ERROR : _FBGC_NO_ERROR;

	#undef gm_right
	#undef obj
}



const char * gm2str(fbgc_grammar gm){
	return gm_name_array[gm];
}
