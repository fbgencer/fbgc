#include "fbgc.h"


//MATRIX_BEGIN
//Autogenerated by helper/grammar_gen2.py
uint8_t left_matrix[90][15] = {
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{2,0,0,2,2,2,0,0,2,0,2,2,2,2,0},
{2,0,0,2,2,2,0,0,2,0,2,2,2,2,0},
{2,0,0,2,2,2,0,0,2,0,2,2,2,2,0},
{2,0,0,2,2,2,0,0,2,0,2,2,2,2,0},
{2,0,0,2,2,2,0,0,2,0,2,2,2,2,0},
{2,0,0,2,2,2,0,0,2,0,2,2,2,2,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{3,0,0,3,3,3,0,0,3,0,3,3,3,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{3,0,0,3,3,3,0,0,3,0,3,3,3,3,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{8,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{14,0,0,0,0,14,0,0,14,0,14,0,0,0,0},
{14,0,0,0,0,14,0,0,14,0,14,0,0,0,0},
{14,0,0,0,0,0,0,14,0,0,0,0,0,0,0},
{14,0,0,0,0,0,0,14,0,0,0,0,0,0,0},
{14,0,0,0,0,0,0,14,0,0,0,0,0,0,0},
{14,0,0,0,0,0,0,14,0,0,0,0,0,0,0},
{1,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{1,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{14,0,0,0,0,0,0,14,0,0,0,0,0,0,0},
{1,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{1,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{11,0,11,11,11,11,0,0,11,0,11,11,11,11,11},
{0,8,8,0,0,0,0,8,0,8,2,0,0,0,8},
{12,0,12,12,12,12,0,12,12,0,12,12,12,0,0},
{0,15,15,0,0,0,0,15,0,15,0,2,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,9,9,0,0,0,0,9,0,0,0,0,0,0,9},
{-4,0,4,-4,0,-4,0,0,-4,0,-4,-4,0,-4,0},
{1,1,1,0,0,0,0,1,0,1,0,0,0,0,1},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{-5,4,4,-5,-5,-5,0,4,-5,0,-5,-5,0,0,4},
{-5,4,4,-5,-5,-5,0,4,-5,0,-5,-5,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{-13,4,4,-13,-13,-13,0,4,-13,0,-13,-13,8,-13,4},
{0,4,4,0,0,0,0,4,0,0,0,0,0,0,4},
{5,0,0,5,5,0,0,0,0,0,0,0,0,0,0},
{5,0,0,5,5,0,0,0,0,0,0,0,0,0,0},
{5,0,0,5,5,0,0,0,0,0,0,0,0,0,0},
{5,0,0,5,5,0,0,0,0,0,0,0,0,0,0},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{0,0,6,0,0,0,0,6,0,0,0,0,0,0,6},
{1,0,0,1,1,0,0,0,1,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{2,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{4,0,0,4,0,4,0,0,4,0,4,4,0,4,0},
};
uint8_t right_matrix[90][15] = {
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{8,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{8,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{8,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{8,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{8,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{8,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,8,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{1,2,3,4,5,6,7,8,9,10,11,12,13,14,3},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,8,0,0,0,0,0,8,0,0,0,0,0,0,0},
{0,8,0,0,0,0,0,8,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,8,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,8,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,8,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,8,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,8,0,0,0,0,0,0,0},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,10,10,0,0,0,0,10,0,0,0,0,0,0,10},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,0,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,8,8,0,0,0,0,8,0,8,0,0,0,0,8},
{0,13,13,0,0,0,0,13,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
};
//MATRIX_END


void gm_convert_left(struct parser_packet * p){
	#define gm_left  (p->gm)
	#define obj 	(p->iter)
	//Just check for special functions.
	int8_t new_left = left_matrix[get_fbgc_object_type(obj)][gm_left - 1];
	
	if(new_left < 0){

		new_left = -new_left;	

		FBGC_LOGV(GRAMMAR,"Grammar gm_left(%s) has a special function definition\n",_gm2str(new_left));
		
		switch(get_fbgc_object_type(obj)){
			case PLUS:
			{
				obj->type = UPLUS;
				break;
			}
			case MINUS:
			{
				obj->type = UMINUS;
				break;
			}
			case PIPE:
			{
				obj->type = LEN;
				break;
			}
			case DOT:
			{
				obj->type = CLASS_SELF;
				break;
			}
			default:
			{
				assert(0);
				break;
			}	
		}

		//gm_left = new_left;
	}
	


	#undef gm_left
	#undef obj
}


uint8_t gm_seek_left(struct parser_packet * p){

	#define gm_left  (p->gm)
	#define obj 	(p->iter)
	//struct fbgc_ll_base * obj = p->iter;
	


	FBGC_LOGD(GRAMMAR,"Grammar LEFT:[%s],Obj:[%s]\n",_gm2str(gm_left),_obj2str(obj));

	int8_t new_left = left_matrix[get_fbgc_object_type(obj)][gm_left-1];

	if(new_left == GM_ERROR){
		_FBGC_LOGE("Unexpected grammar! LEFT:(%s), OBJ:(%s)\n",_gm2str(gm_left),_obj2str(obj));
	}

	gm_left = new_left;

	p->error_code = (new_left == GM_ERROR) ? _FBGC_SYNTAX_ERROR : _FBGC_NO_ERROR;

	return (new_left == GM_ERROR) ? _FBGC_SYNTAX_ERROR : _FBGC_NO_ERROR;

	#undef gm_left
	#undef obj
}

uint8_t gm_seek_right(struct parser_packet * p){

	#define gm_right  (p->gm)
	#define obj 	(TOP_LL(p->op))
	
	FBGC_LOGD(GRAMMAR,"Grammar Obj:[%s],RIGHT:[%s]\n",_obj2str(obj),_gm2str(gm_right));

	int8_t new_right = right_matrix[get_fbgc_object_type(obj)][gm_right-1];

	if(new_right == GM_ERROR){
		_FBGC_LOGE("Unexpected grammar! Obj:(%s) RIGHT:(%s)\n",_obj2str(obj),_gm2str(gm_right));
	}
	
	gm_right = new_right;
	p->error_code = (new_right == GM_ERROR) ? _FBGC_SYNTAX_ERROR : _FBGC_NO_ERROR;
	return (new_right == GM_ERROR) ? _FBGC_SYNTAX_ERROR : _FBGC_NO_ERROR;

	#undef gm_right
	#undef obj
}



inline const char * gm2str(fbgc_grammar gm){
	return gm_name_array[gm];
}
